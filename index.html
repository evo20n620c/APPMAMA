<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Reloj Familiar Premium - Paisajes Reales</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Quicksand:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { 
            --bg: #000; --card: #111; --dim: #777; 
            --font-soft: 'Quicksand', sans-serif;
            --font-msg: 'Caveat', cursive;
            --luna-plata: #d1d1d1; --accent: #4ade80; --trivia-accent: #facc15;
        }
        #anti-burn-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 1s ease-in-out; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; overflow: hidden; font-family: var(--font-soft); }
        
        .grid { display: grid; grid-template-columns: 50% 50%; grid-template-rows: 25% 75%; height: 100vh; padding: 20px; box-sizing: border-box; gap: 20px; }
        .box { background: var(--card); border-radius: 40px; border: 1px solid #1a1a1a; display: flex; position: relative; overflow: hidden; }

        .top-left-group { flex-direction: row; justify-content: space-evenly; align-items: center; padding: 10px 20px; }
        .time-info { text-align: center; flex: 1.3; }
        #hora { font-size: 5.5rem; font-weight: 300; line-height: 1; letter-spacing: -2px; }
        #fecha { font-size: 1.1rem; color: var(--dim); margin-top: 8px; white-space: nowrap; letter-spacing: 1px; }
        
        .weather-divider { width: 1px; height: 50%; background: #333; margin: 0 10px; }
        .weather-info { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; gap: 0; }
        .lucide { width: 90px; height: 90px; stroke-width: 1.5px; }
        #clima-temp { font-size: 4.5rem; font-weight: 300; line-height: 1; }

        .top-right-msg { background: transparent !important; border: none !important; justify-content: center; align-items: center; height: 100%; overflow: hidden; }
        #msg-arriba { font-family: var(--font-msg); line-height: 1.1; text-align: center; max-width: 95%; transition: opacity 1s ease; }

        .bottom-left-agenda { padding: 40px; flex-direction: column; justify-content: flex-start; }
        #contenedor-agenda { width: 100%; text-align: left; }
        .agenda-evento { font-size: 2rem; color: #eee; margin-bottom: 12px; display: flex; align-items: flex-start; gap: 15px; }
        .agenda-evento::before { content: ""; min-width: 10px; height: 10px; background: var(--accent); border-radius: 50%; margin-top: 12px; }

        .bottom-right-container { display: flex; flex-direction: column; gap: 20px; background: transparent; border: none; height: 100%; overflow: hidden; }
        .paisaje-mini-box { height: 60%; background: #000; border-radius: 40px; overflow: hidden; border: 1px solid #1a1a1a; position: relative; flex-shrink: 0; }
        
        .layer { position: absolute; width: 100%; height: 100%; transition: opacity 2s ease-in-out; opacity: 0; background-size: cover; background-position: center; }
        .layer.active { opacity: 1; }

        .trivia-box { height: calc(40% - 20px); background: linear-gradient(145deg, #111, #050505); border-radius: 40px; border: 1px solid #1a1a1a; padding: 20px 30px; display: flex; flex-direction: column; justify-content: center; text-align: center; box-sizing: border-box; flex-shrink: 0; }
        .trivia-txt, .trivia-res { font-family: var(--font-soft); font-size: 1.5rem; line-height: 1.25; margin-bottom: 10px; }
        .trivia-txt { color: #fff; }
        .trivia-res { color: var(--accent); } 
        .trivia-opciones { font-family: var(--font-soft); font-size: 1.2rem; color: #aaa; text-align: left; padding-left: 20px; line-height: 1.5; }
    </style>
</head>
<body>
<div id="anti-burn-container">
    <div class="grid">
        <div class="box top-left-group">
            <div class="time-info"><div id="hora">--:--</div><div id="fecha">...</div></div>
            <div class="weather-divider"></div>
            <div class="weather-info"><div id="clima-icon"></div><div id="clima-temp">--°</div></div>
        </div>
        <div class="box top-right-msg"><div id="msg-arriba">Cargando...</div></div>
        <div id="caja-agenda" class="box bottom-left-agenda"><div id="contenedor-agenda"></div></div>
        <div class="bottom-right-container">
            <div class="paisaje-mini-box" id="cuadrante-paisaje">
                <div class="layer active" id="capa1"></div>
                <div class="layer" id="capa2"></div>
            </div>
            <div class="trivia-box" id="trivia-container"><div id="trivia-content" style="transition: opacity 0.5s;"><div class="trivia-txt">Cargando trivia...</div></div></div>
        </div>
    </div>
</div>

<script>
    const AGENDA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR7-WKumAlyEyQXUD9I-5qhxn0vBbI6M238FwuhctONAQfcsmKhwAIfO5gLbnZhiild3nqmRR-2n9mo/pub?output=csv';
    const FRASES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQsVTl_DwnvHg14G_rV5iUFOHal3B4w3llcCZsZwTNMh7uvx8YXdctdWXX2nbRVRpxizkZPKb665nKo/pub?output=csv';
    const TRIVIA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTtMdkYueUYgWcnwisUPstM2S4o2VTMbAyZ48QIu4eYWXvK0U9JGfmn0VyT3axG_7jgEmixm6Lzhg_E/pub?output=csv';

    let triviasExterna = [];
    let triviaFase = 0; 
    let triviaActual = null;

    async function cargarTriviaExterna() {
        try {
            const r = await fetch(TRIVIA_URL + '&t=' + Date.now());
            const text = await r.text();
            const lineas = text.split(/\r?\n/);
            triviasExterna = lineas.map(l => {
                const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (c.length < 5) return null;
                return { 
                    p: c[0].replace(/^"|"$/g, '').trim(), 
                    o: [`A) ${c[1].replace(/^"|"$/g, '').trim()}`, `B) ${c[2].replace(/^"|"$/g, '').trim()}`, `C) ${c[3].replace(/^"|"$/g, '').trim()}`], 
                    r: c[4].replace(/^"|"$/g, '').trim() 
                };
            }).filter(t => t !== null && t.p !== "");
        } catch (e) { }
    }

    function reloj() {
        const ahora = new Date();
        document.getElementById('hora').textContent = ahora.getHours().toString().padStart(2, '0') + ":" + ahora.getMinutes().toString().padStart(2, '0');
        const d = ahora.toLocaleDateString('es-AR', { weekday: 'short' }).replace('.', '').toLowerCase();
        document.getElementById('fecha').textContent = `${d} ${ahora.getDate()} ${ahora.toLocaleDateString('es-AR', { month: 'short' }).replace('.', '')} ${ahora.getFullYear()}`;
    }

    async function clima() {
        try {
            const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=-34.61&longitude=-58.43&current=temperature_2m,weather_code');
            const d = await r.json();
            document.getElementById('clima-temp').textContent = Math.round(d.current.temperature_2m) + "°";
            const icon = d.current.weather_code <= 1 ? (new Date().getHours() >= 20 || new Date().getHours() < 7 ? 'moon' : 'sun') : (d.current.weather_code >= 51 ? 'cloud-rain' : 'cloud');
            document.getElementById('clima-icon').innerHTML = `<i data-lucide="${icon}"></i>`;
            lucide.createIcons();
        } catch (e) {}
    }

    async function cargarAgenda() {
        const h = new Date().getHours();
        const contenedor = document.getElementById('contenedor-agenda');
        if (h >= 22 || h < 7) { 
            document.getElementById('caja-agenda').style.background = "#000";
            contenedor.innerHTML = `<div style="text-align: center;"><img src="https://lh3.googleusercontent.com/d/1CwXkKNllm_hCjLKacZjTywh7gm2FCKrp" style="width: 80%; opacity: 0.7; border-radius: 20px; margin-top: 40px;"><div style="font-family: var(--font-msg); color: #777; font-size: 2.2rem; margin-top: 25px;">…que linda mi camita… para descansar…</div></div>`;
            return; 
        }
        document.getElementById('caja-agenda').style.background = "var(--card)";
        try {
            const r = await fetch(AGENDA_URL + '&t=' + Date.now());
            const lineas = (await r.text()).split(/\r?\n/);
            let hTotal = ""; const hoy = new Date();
            for (let i = 0; i < 2; i++) {
                let fLoop = new Date(); fLoop.setDate(hoy.getDate() + i);
                let fBusqueda = `${fLoop.getDate().toString().padStart(2,'0')}/${(fLoop.getMonth()+1).toString().padStart(2,'0')}/${fLoop.getFullYear().toString().slice(-2)}`;
                const eventos = lineas.filter(l => l.includes(fBusqueda));
                let lista = eventos.map(l => `<li class="agenda-evento">${l.split(',')[1].replace(/"/g, '')}</li>`).join('');
                hTotal += `<div style="margin-bottom:25px;"><div style="font-size:1.2rem;color:var(--dim);text-transform:uppercase;font-weight:700;margin-bottom:18px;">${i===0?'HOY':'MAÑANA'} ${fLoop.getDate()}/${fLoop.getMonth()+1}</div><ul style="list-style:none;padding:0;">${lista || 'Sin actividades'}</ul></div>`;
            }
            contenedor.innerHTML = hTotal;
        } catch (e) {}
    }

    let alternarCapa = true;
    function actualizarPaisaje() {
        const c1 = document.getElementById('capa1'), c2 = document.getElementById('capa2');
        const target = alternarCapa ? c2 : c1, old = alternarCapa ? c1 : c2;
        
        // Usamos Picsum con un ID aleatorio alto para asegurar paisajes de naturaleza
        const randomId = Math.floor(Math.random() * 500) + 10;
        const imgUrl = `https://picsum.photos/id/${randomId}/1000/800`;
        
        const img = new Image();
        img.src = imgUrl;
        img.onload = () => { 
            setTimeout(() => {
                target.style.backgroundImage = `url('${imgUrl}')`;
                target.classList.add('active'); 
                old.classList.remove('active'); 
                alternarCapa = !alternarCapa; 
            }, 500);
        };
        // Si el ID no existe, Picsum redirige automáticamente, así que siempre cargará algo.
    }

    function actualizarTrivia() {
        if (triviasExterna.length === 0) return;
        const content = document.getElementById('trivia-content');
        if (new Date().getHours() >= 22 || new Date().getHours() < 7) { document.getElementById('trivia-container').style.opacity = "0"; return; }
        document.getElementById('trivia-container').style.opacity = "1";

        content.style.opacity = 0;
        setTimeout(() => {
            if (triviaFase === 0) {
                triviaActual = triviasExterna[Math.floor(Math.random() * triviasExterna.length)];
                content.innerHTML = `<div class="trivia-txt">${triviaActual.p}</div><div class="trivia-opciones">${triviaActual.o.map(opt => `<div>${opt}</div>`).join("")}</div>`;
                triviaFase = 1;
            } else {
                content.innerHTML = `<div class="trivia-res">${triviaActual.r}</div>`;
                triviaFase = 0;
            }
            content.style.opacity = 1;
        }, 500);
    }

    async function actualizarMensaje() {
        const msg = document.getElementById('msg-arriba');
        try {
            const r = await fetch(FRASES_URL + '&t=' + Date.now());
            const csv = await r.text();
            let txt = ""; const min = new Date().getHours() * 60 + new Date().getMinutes();
            csv.split(/\r?\n/).forEach(l => {
                let c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (c.length < 3 || c[0].includes("desde")) return;
                let dM = parseInt(c[0].split(':')[0])*60 + parseInt(c[0].split(':')[1] || 0);
                let hM = parseInt(c[1].split(':')[0])*60 + parseInt(c[1].split(':')[1] || 0);
                if (hM < dM ? (min >= dM || min < hM) : (min >= dM && min < hM)) txt = c[2].replace(/"/g, '').trim();
            });
            msg.style.opacity = 0;
            setTimeout(() => {
                msg.innerHTML = txt;
                msg.style.color = (new Date().getHours() >= 21 || new Date().getHours() < 7) ? '#74b9ff' : '#ff7675';
                msg.style.fontSize = (new Date().getHours() >= 21 || new Date().getHours() < 7) ? "1.8rem" : "2.6rem";
                msg.style.opacity = 1;
            }, 800);
        } catch (e) {}
    }

    reloj(); clima(); cargarAgenda(); actualizarPaisaje(); cargarTriviaExterna().then(actualizarTrivia); actualizarMensaje();
    setInterval(reloj, 1000); setInterval(clima, 300000); setInterval(cargarAgenda, 60000); 
    setInterval(actualizarPaisaje, 8000); 
    setInterval(actualizarTrivia, 8000); setInterval(actualizarMensaje, 30000);
    setInterval(cargarTriviaExterna, 3600000);
</script>
</body>
</html>

